{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<link rel="stylesheet" href="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.css">
{% endblock %}

{% block content %}
<div class="data-page">
    <!-- Intro Section -->
    <div class="data-intro">
        <div class="data-intro-content">
            <h1>Data Collection</h1>
            <p>Curated datasets from various domains, regularly updated and freely available. Each set includes metadata, download options, and mirror links for major platforms.</p>
        </div>
        <div class="data-intro-image">
            <img src="{{ static_prefix }}/la-corniche-near-monaco-detail-2.png" alt="La Corniche near Monaco. Claude Monet, 1884" />
        </div>
    </div>

    {% for dataset in datasets %}
    <div class="data-section">
        <div class="data-section-header">
            <h2 class="data-section-title">{{ dataset.title }}</h2>
        </div>
        <div class="data-section-badge">
            <img src="{{ dataset.badge_url }}" alt="GitHub Actions" />
        </div>

        <div class="data-section-meta">
            <div class="meta-item">
                <span class="meta-label">Size</span>
                <span class="meta-value" id="{{ dataset.id }}-data-size">Loading...</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Type</span>
                <span class="meta-value">{{ dataset.type }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Rows</span>
                <span class="meta-value" id="{{ dataset.id }}-rows">Loading...</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Updates</span>
                <span class="meta-value">{{ dataset.updates }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">History</span>
                <span class="meta-value">{{ dataset.history }}</span>
            </div>
        </div>

        <div class="data-section-description">
            {{ dataset.description }}
        </div>

        <p class="download-options">Download options</p>

        <div class="platform-links">
            {% for platform in dataset.platforms %}
            <a href="{{ platform.url }}" class="platform-link" target="_blank" rel="noopener noreferrer">
                {% if platform.icon == "img" %}
                <img src="{{ static_prefix }}{{ platform.icon_src }}" alt="{{ platform.name }}" style="width: 16px; height: 16px;">
                {% else %}
                <i class="{{ platform.icon }}"></i>
                {% endif %}
                {{ platform.name }}
            </a>
            {% endfor %}
        </div>

        <div class="code-snippet-container">
            <pre><code class="language-bash"># Or simply use curl
{{ dataset.download_command }}</code></pre>
        </div>
    </div>
    {% endfor %}    
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.js"></script>
<script>    
    hljs.highlightAll();
    hljs.addPlugin(new CopyButtonPlugin());
    
    // Function to fetch dataset information from Hugging Face API
    async function fetchDatasetInfo(datasetName, rowsElementId, sizeElementId, fallbackRows, fallbackSize) {
        const API_URL = `https://datasets-server.huggingface.co/info?dataset=vtasca/${datasetName}`;
        
        try {
            const response = await fetch(API_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Extract the information we need
            const numExamples = data.dataset_info.default.splits.train.num_examples;
            const numBytes = data.dataset_info.default.splits.train.num_bytes;
            const sizeInMB = (numBytes / (1024 * 1024)).toFixed(1);
            
            // Update the DOM elements
            const rowsElement = document.getElementById(rowsElementId);
            const sizeElement = document.getElementById(sizeElementId);
            
            if (rowsElement) {
                rowsElement.textContent = numExamples.toLocaleString();
            }
            
            if (sizeElement) {
                sizeElement.textContent = `${sizeInMB} MB`;
            }
            
        } catch (error) {
            console.error(`Error fetching ${datasetName} dataset info:`, error);
            
            // Fallback to default values on error
            const rowsElement = document.getElementById(rowsElementId);
            const sizeElement = document.getElementById(sizeElementId);
            
            if (rowsElement) {
                rowsElement.textContent = fallbackRows;
            }
            
            if (sizeElement) {
                sizeElement.textContent = fallbackSize;
            }
        }
    }
    
    // Function to fetch all dataset information
    async function fetchAllDatasetInfo() {
        const datasets = {{ datasets | tojson }};
        
        for (const dataset of datasets) {
            await fetchDatasetInfo(
                dataset.huggingface_dataset_name,
                `${dataset.id}-rows`,
                `${dataset.id}-data-size`,
                dataset.fallback_rows,
                dataset.fallback_size
            );
        }
    }
    
    // Fetch all dataset info when the page loads
    document.addEventListener('DOMContentLoaded', fetchAllDatasetInfo);
</script>
{% endblock %}